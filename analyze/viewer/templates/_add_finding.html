<div class="modal fade" id="addFindingModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header">
        <h5 class="modal-title">Add Finding</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <form id="addFindingForm">

          <!-- Collection selector -->
          <div class="mb-3">
            <label for="findingCollection" class="form-label">
              Collection
            </label>
            <select
              class="form-select bg-dark text-light"
              id="findingCollection"
              required
            >
              <option value="" disabled selected>Select a collection…</option>
              {% for c in all_collections %}
                <option value="{{ c }}"
                  {% if c == session.get("collection_name") %}selected{% endif %}>
                  {{ c }}
                </option>
              {% endfor %}
            </select>
            <div class="invalid-feedback">
              Collection is required.
            </div>
          </div>

          <!-- Timeline selector -->
          <div class="mb-3">
            <label for="findingTimeline" class="form-label">
              Timeline
            </label>
            <select
              class="form-select bg-dark text-light"
              id="findingTimeline"
              required
            >
              <option value="" disabled selected>Select a timeline…</option>
              {% for t in all_timelines %}
                <option value="{{ c }}"
                  {% if t == session.get("timeline_name") %}selected{% endif %}>
                  {{ t }}
                </option>
              {% endfor %}
            </select>
            <div class="invalid-feedback">
              Collection is required.
            </div>
          </div>

          <!-- Message (mandatory) -->
          <div class="mb-3">
            <label for="findingMessage" class="form-label">
              Message <span class="text-danger">*</span>
            </label>
            <input type="text" class="form-control bg-dark text-light" id="findingMessage" placeholder="Required" required>
            <div class="invalid-feedback">Message is required.</div>
          </div>

          <!-- Meta (JSON) -->
          <div class="mb-3">
            <label for="findingMeta" class="form-label">Meta (JSON)</label>
            <textarea class="form-control bg-dark text-light" id="findingMeta" rows="2" placeholder='e.g. {"key":"value"}'></textarea>
          </div>

          <!-- Artifact -->
          <div class="mb-3">
            <label for="findingArtifact" class="form-label">Artifact</label>
            <input type="text" class="form-control bg-dark text-light" id="findingArtifact" placeholder="Optional">
          </div>

          <!-- Indicator -->
          <div class="mb-3">
            <label for="findingIndicator" class="form-label">Indicator</label>
            <input type="text" class="form-control bg-dark text-light" id="findingIndicator" placeholder="Optional">
          </div>

        </form>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-warning" id="saveFindingBtn">Add Finding</button>
      </div>
    </div>
  </div>
</div>

<script>
$(document).ready(function () {

  $('#saveFindingBtn').on('click', function () {

    const message = $('#findingMessage').val().trim();
    const metaText = $('#findingMeta').val().trim();
    const artifact = $('#findingArtifact').val().trim();
    const collection = $('#findingCollection').val();
    const timeline = $('#findingTimeline').val();
    const indicator = $('#findingIndicator').val().trim();

    // Validate required field
    if (!message) {
      $('#findingMessage').addClass('is-invalid');
      return;
    }
    $('#findingMessage').removeClass('is-invalid');

    // Parse meta JSON if provided
    let meta = null;
    if (metaText) {
      try {
        meta = JSON.parse(metaText);
      } catch (e) {
        alert('Meta field must be valid JSON');
        return;
      }
    }

    const data = {
      collection: collection || null,
      timeline: timeline || null,
      message: message,
      meta: meta,
      artifact: artifact || null,
      indicator: indicator || null
    };

    $.ajax({
      url: "/findings",
      type: "POST",
      contentType: "application/json",
      data: JSON.stringify(data),

      success: function (resp) {
        const findingId = resp.id;
        const url = `${window.location.origin}/findings/${findingId}`;

        const alertHtml = `
          <div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
            <strong>Finding created.</strong>
            <a href="${url}" class="alert-link ms-2">
              View finding #${findingId}
            </a>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        `;

        // Show success alert near top of page content
        $('.container-fluid.px-4.mt-4').prepend(alertHtml);

        // Close modal
        const modalEl = document.getElementById('addFindingModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        modal.hide();

        // Reset form
        $('#addFindingForm')[0].reset();
      },

      error: function (xhr) {
        const msg = xhr.responseJSON?.error || 'Unknown error';
        alert('Failed to add finding: ' + msg);
      }
    });

  });

});
</script>
