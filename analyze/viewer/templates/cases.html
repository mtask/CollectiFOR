{% extends "base.html" %}
{% block content %}
<h2 class="text-light mb-3">Cases</h2>

<div class="mb-3">
  <button class="btn btn-success" id="new-case-btn">New Case</button>
</div>

<!-- Cases List -->
<ul class="list-group mb-3" id="cases-list">
  {% for case in all_cases %}
  <li
    class="list-group-item bg-dark text-light d-flex justify-content-between align-items-center"
    data-id="{{ case.id }}"
  >
    <a href="{{ url_for('cases.case_detail', case_id=case.id) }}" class="text-light">
      {{ case.case_name }}
    </a>

    <div class="d-flex align-items-center gap-2">
      <span class="text-light small">
        {{ case.inserted_at.strftime('%Y-%m-%d %H:%M') }}
      </span>

      <button
        type="button"
        class="btn btn-sm btn-danger delete-case-btn"
        data-id="{{ case.id }}"
        title="Delete case"
      >
        <i class="bi bi-trash"></i>
      </button>
    </div>
  </li>
  {% endfor %}
</ul>

<script>
$(document).ready(function () {

  // --- Add new case note ---
  $('#save-case-note').on('click', function() {
    const comment = $('#new-case-note').val().trim();
    if (!comment || !currentCaseId) return;

    fetch(`/cases/case/${currentCaseId}/note/add`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ case_comment: comment })
    })
    .then(r => r.json())
    .then(note => {
      const html = `
        <div class="mb-2 p-2 border rounded">
          <div class="small text-muted">
            ${new Date(note.inserted_at).toLocaleString()}
          </div>
          <div>${note.case_comment}</div>
        </div>`;
      $('#case-notes-timeline').append(html);
      $('#new-case-note').val('');
    });
  });

  // --- Add new case ---
  $('#new-case-btn').on('click', function() {
    const caseName = prompt("Enter new case name:");
    if (!caseName) return;

    fetch("/cases/case/add", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ case_name: caseName })
    })
    .then(r => r.json())
    .then(newCase => {
      const html = `
        <li
          class="list-group-item bg-dark text-light d-flex justify-content-between align-items-center"
          data-id="${newCase.id}"
        >
          <a href="/cases/case/${newCase.id}" class="text-light">
            ${newCase.case_name}
          </a>

          <div class="d-flex align-items-center gap-2">
            <span class="text-light small">
              ${new Date(newCase.inserted_at).toLocaleString()}
            </span>
            <button
              type="button"
              class="btn btn-sm btn-danger delete-case-btn"
              data-id="${newCase.id}"
            >
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </li>`;
      $('#cases-list').prepend(html);
    });
  });

  // --- Delete case ---
  $(document).on('click', '.delete-case-btn', function (e) {
    e.preventDefault();
    e.stopPropagation();

    const caseId = $(this).data('id');

    if (!confirm('Delete this case? This action cannot be undone.')) {
      return;
    }

    fetch(`/cases/case/${caseId}`, {
      method: 'DELETE'
    })
    .then(res => {
      if (!res.ok) throw new Error();
      $(`li[data-id="${caseId}"]`).remove();
    })
    .catch(() => alert('Failed to delete case'));
  });

});
</script>

{% endblock %}
