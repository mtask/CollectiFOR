{% extends "base.html" %}
{% block content %}
<div class="container-fluid px-4 text-light">
  <div class="d-flex flex-column flex-md-row align-items-center justify-content-center justify-content-md-between mb-3 w-100">
    <h2>
      {% if finding.rule %}
        {% if finding.ack %}✅{% else %}⚠️ {%endif%} {{ finding.type }} – {{ finding.rule }} (#{{ finding.id }})
      {% elif finding.indicator %}
        {% if finding.ack %}✅{% else %}⚠️ {%endif%} {{ finding.type }} – {{ finding.indicator }} (#{{ finding.id }})
      {% else %}
        {% if finding.ack %}✅{% else %}⚠️ {%endif%} {{ finding.type }} (#{{ finding.id }})
      {% endif %}
    </h2>

<div class="d-flex flex-wrap gap-2">
  <!-- Add Note Button -->
  <button
    type="button"
    class="btn btn-lg btn-primary"
    data-bs-toggle="modal"
    data-bs-target="#addNoteModal"
  >
    <i class="bi bi-plus-circle me-1"></i> Add note
  </button>

  {% if finding.case_id %}
    <a
      href="{{ url_for('cases.case_detail', case_id=finding.case_id) }}"
      class="btn btn-lg btn-primary"
    >
      CASE: {{ finding.case_name }}
    </a>
    <button class="btn btn-lg btn-primary add-case-btn" data-id="{{ finding.id }}">
      Change Case
    </button>
  {% else %}
    <button class="btn btn-lg btn-info add-case-btn" data-id="{{ finding.id }}">
      Add Case
    </button>
  {% endif %}
<button
  type="button"
  class="btn btn-lg {{ 'btn-outline-secondary' if finding.ack else 'btn-success' }} ack-btn"
  data-id="{{ finding.id }}"
  data-ack="{{ 'true' if finding.ack else 'false' }}"
>
  <i class="bi {{ 'bi-check-circle' if finding.ack else 'bi-circle' }} me-1"></i>
  {{ 'Unack' if finding.ack else 'Ack' }}
</button>
</div>


  </div>
</div>

  <table class="table table-dark table-striped table-sm">
      <tbody>
          <tr>
              <th>Collection</th>
              <td>{{ finding.collection_name }}</td>
          </tr>
          <tr>
              <th>Timeline</th>
              <td>{{ finding.timeline_name }}</td>
          </tr>
          <tr>
              <th>Message</th>
              <td>{{ finding.message }}</td>
          </tr>
          <tr>
              <th>Artifact</th>
              <td>{{ finding.artifact }}</td>
          </tr>
          <tr>
              <th>Indicator</th>
              <td>{{ finding.indicator }}</td>
          </tr>
      </tbody>
  </table>

  {% if finding.meta %}
  <h3 class="mt-4">Metadata</h3>
  <table class="table table-dark table-striped table-sm">
      <thead class="table-secondary">
          <tr>
              <th>Key</th>
              <th>Value</th>
          </tr>
      </thead>
      <tbody>
      {% for key, value in finding.meta.items() %}
          <tr>
              <td>{{ key }}</td>
              <td>{{ value }}</td>
          </tr>
      {% endfor %}
      </tbody>
  </table>
  {% else %}
  <p class="text-light">No metadata available.</p>
  {% endif %}

  {% if comments %}
  <h3 class="mt-4">Notes</h3>
  <table class="table table-dark table-striped table-sm">
      <thead class="table-secondary">
          <tr>
              <th>Timestamp</th>
              <th>Comment</th>
          </tr>
      </thead>
      <tbody>
      {% for c in comments %}
          <tr>
              <td>{{ c.inserted_at }}</td>
              <td>{{ c.finding_comment }}</td>
          </tr>
      {% endfor %}
      </tbody>
  </table>
  {% else %}
  <p class="text-light">No notes available.</p>
  {% endif %}
</div>

<div class="modal fade" id="addNoteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header">
        <h5 class="modal-title">Add Note</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="mb-3">
          <label for="noteComment" class="form-label">
            Comment <span class="text-danger">*</span>
          </label>
          <textarea
            class="form-control bg-dark text-light"
            id="noteComment"
            rows="4"
            placeholder="Write your note here…"
            required
          ></textarea>
          <div class="invalid-feedback">
            Comment is required.
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-primary" id="saveNoteBtn">
          Save note
        </button>
      </div>
    </div>
  </div>
</div>
<script>
$(document).ready(function () {
  // --- Add Note ---
  $('#saveNoteBtn').on('click', function () {
    const comment = $('#noteComment').val().trim();
    if (!comment) { $('#noteComment').addClass('is-invalid'); return; }
    $('#noteComment').removeClass('is-invalid');
    $.ajax({
      url: window.location.pathname,
      type: 'POST',
      contentType: 'application/json',
      data: JSON.stringify({ comment }),
      success: function () { location.reload(); },
      error: function () { alert('Failed to save note'); }
    });
  });

  // --- Ack / Unack ---
  let currentFindingId = null;
  const ackModalEl = document.getElementById('ackCommentModal');
  if (ackModalEl) {
    const ackModal = new bootstrap.Modal(ackModalEl);

    $(document).on('click', '.ack-btn', function() {
      currentFindingId = $(this).data('id');
      $('#ackComment').val('');
      $('#ackComment').removeClass('is-invalid');
      ackModal.show();
    });

    $('#confirmAck').on('click', function() {
      const comment = $('#ackComment').val().trim();
      if (!comment) { $('#ackComment').addClass('is-invalid'); return; }
      $('#ackComment').removeClass('is-invalid');

      const button = $(`.ack-btn[data-id='${currentFindingId}']`);
      const ackValue = button.data('ack') === true || button.data('ack') === 'true';
      const newAckValue = !ackValue;

      $.ajax({
        url: `/findings/${currentFindingId}/ack`,
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ ack: newAckValue, ack_comment: comment }),
        success: function() {
          button.data('ack', newAckValue);
          if (newAckValue) {
            button.removeClass('btn-success').addClass('btn-outline-secondary');
            button.html('<i class="bi bi-check-circle me-1"></i> Unack');
          } else {
            button.removeClass('btn-outline-secondary').addClass('btn-success');
            button.html('<i class="bi bi-circle me-1"></i> Ack');
          }
          ackModal.hide();
          location.reload();
        },
        error: function() { alert('Error updating acknowledgement'); }
      });
    });
  }

});
</script>
{% include "_add_case.html" %}
{% include "_ack_modal.html" %}
{% endblock %}

