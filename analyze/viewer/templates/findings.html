{% extends "base.html" %}
{% block content %}

<div class="d-flex justify-content-center align-items-center mb-4">
  <h2 class="text-light mb-0 d-flex align-items-center">
  Findings
  <i
  class="bi bi-question-circle-fill text-primary ms-2"
  style="cursor: pointer; font-size: 1.2rem;"
  tabindex="0"
  data-bs-toggle="popover"
  data-bs-trigger="focus"
  data-bs-placement="right"
  data-bs-html="true"
  title="Search Box Help"    data-bs-content="
<b>Search Box How-To:</b><br><br>
1. <b>Free-text search:</b><br>
&emsp;Type one or more words to filter messages containing all words.<br>
&emsp;Example: <code>ssh sudo</code> → messages containing both 'ssh' AND 'sudo'.<br><br>
2. <b>Negation:</b><br>
&emsp;Prefix a word with '-' to exclude messages containing it.<br>
&emsp;Example: <code>ssh -root</code> → messages containing 'ssh' but NOT 'root'.<br><br>
3. <b>Multi-term filtering:</b><br>
&emsp;Combine multiple include and exclude terms.<br>
&emsp;Example: <code>ssh sudo -root -admin</code><br>
&emsp;→ messages containing 'ssh' AND 'sudo' AND NOT containing 'root' OR 'admin'.<br><br>
4. <b>Quotes</b><br>
&emsp;Include as one string → &quot;include this text&quot;.<br>
&emsp;Exclude as one string → -&quot;exclude this text&quot;.<br><br>
5. <b>Type / Rule filters:</b><br>
&emsp;Use the dropdowns to select one or more event types or rules.<br>
&emsp;Multiple selections are allowed via checkboxes.<br>
"
  ></i>
  </h2>
</div>

<div class="row mb-3 justify-content-center align-items-end">
  <div class="col-md-10">
    <form method="get" class="d-flex gap-2 flex-wrap align-items-end">

      <!-- Input + button group -->
      <div class="input-group">
        <input
          type="text"
          name="q"
          placeholder="Search message (prefix '-' to negate)"
          value="{{ search_query|default('') }}"
          class="form-control"
        >
        <button type="submit" class="btn btn-primary">
          Filter
        </button>
      </div>

      <!-- Type dropdown with checkboxes -->
      <select
        name="type"
        class="selectpicker form-control"
        multiple
        data-actions-box="true"
        data-live-search="true"
        title="Select type(s)"
      >
        {% for t in all_types %}
          <option value="{{ t }}" {% if t in type_filter %}selected{% endif %}>{{ t }}</option>
        {% endfor %}
      </select>

      <!-- Rule dropdown with checkboxes -->
      <select
        name="rule"
        class="selectpicker form-control"
        multiple
        data-actions-box="true"
        data-live-search="true"
        title="Select rule(s)"
      >
        {% for r in all_rules %}
          <option value="{{ r }}" {% if r in rule_filter %}selected{% endif %}>{{ r }}</option>
        {% endfor %}
      </select>

    </form>
  </div>
</div>

<script>
  $(document).ready(function() {
    $('.selectpicker').selectpicker();
  });
  // Help "popup"
  document.addEventListener("DOMContentLoaded", function () {
    var popoverTriggerList = [].slice.call(
      document.querySelectorAll('[data-bs-toggle="popover"]')
    );
    popoverTriggerList.map(function (popoverTriggerEl) {
      return new bootstrap.Popover(popoverTriggerEl);
    });
  });
</script>


{% if findings %}
<table class="table table-dark table-striped table-hover table-sm">
    <thead class="table-secondary">
        <tr>
            <th>Type</th>
            <th>Rule</th>
            <th>Message</th>
            <th>Artifact</th>
            <th>Inserted</th>
        </tr>
    </thead>
    <tbody>
    {% for f in findings %}
        <tr class="finding-{{ f.type }}">
            <td>{{ f.type }}</td>
            <td>{{ f.rule }}</td>
            <td>
                <a href="/findings/{{ f.id }}" class="text-info text-decoration-none">{{ f.message }}</a>
            </td>
            <td class="mono">{{ f.artifact }}</td>
            <td>{{ f.inserted_at }}</td>
        </tr>
    {% endfor %}
    </tbody>
</table>
{% else %}
<p class="text-light">No findings available.</p>
{% endif %}
{% endblock %}
