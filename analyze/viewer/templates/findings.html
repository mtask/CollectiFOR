{% extends "base.html" %}
{% block content %}

<div class="d-flex justify-content-center align-items-center mb-4">
  <h2 class="text-light mb-0 d-flex align-items-center">
  Findings ({{ findings|default([])|length }})
  <i
  class="bi bi-question-circle-fill text-primary ms-2"
  style="cursor: pointer; font-size: 1.2rem;"
  tabindex="0"
  data-bs-toggle="popover"
  data-bs-trigger="focus"
  data-bs-placement="right"
  data-bs-html="true"
  title="Search Box Help"    data-bs-content="
<b>Search Box How-To:</b><br><br>
1. <b>Free-text search:</b><br>
&emsp;Type one or more words to filter messages containing all words.<br>
&emsp;Example: <code>ssh sudo</code> → messages containing both 'ssh' AND 'sudo'.<br><br>
2. <b>Negation:</b><br>
&emsp;Prefix a word with '-' to exclude messages containing it.<br>
&emsp;Example: <code>ssh -root</code> → messages containing 'ssh' but NOT 'root'.<br><br>
3. <b>OR operator:</b><br>
&emsp;Use <code>|</code> to match any of multiple terms within a group.<br>
&emsp;Example: <code>user|admin</code> → messages containing 'user' OR 'admin'.<br>
&emsp;Combine with spaces for AND logic: <code>user|admin ssh</code> → ('user' OR 'admin') AND 'ssh'.<br><br>
4. <b>Multi-term filtering:</b><br>
&emsp;Combine multiple include and exclude terms.<br>
&emsp;Example: <code>ssh sudo -root -admin</code><br>
&emsp;→ messages containing 'ssh' AND 'sudo' AND NOT containing 'root' OR 'admin'.<br><br>
5. <b>Quotes:</b><br>
&emsp;Include as one string →  &quot;include this text &quot;.<br>
&emsp;Exclude as one string → - &quot;exclude this text &quot;.<br>
6. <b>Type / Rule filters:</b><br>
&emsp;Use the dropdowns to select one or more event types or rules.<br>
&emsp;Multiple selections are allowed via checkboxes.<br>
"
  ></i>
  </h2>
</div>

<div class="row mb-3 justify-content-center align-items-end">
  <div class="col-md-10">
    <form method="get">

      <!-- Input + button group (left-aligned) -->
      <div class="input-group mb-2">
        <input
          type="text"
          name="q"
          placeholder="Search message (prefix '-' to negate)"
          value="{{ search_query|default('') }}"
          class="form-control"
        >
        <button type="submit" class="btn btn-primary">
          Filter
        </button>
        <a href="{{ url_for('findings') }}" class="btn btn-secondary">
          Reset
        </a>
      </div>

      <!-- Centered dropdowns -->
      <div class="d-flex justify-content-center gap-2 flex-wrap">
        <!-- Type dropdown -->
        <select
          name="type"
          class="selectpicker"
          multiple
          data-actions-box="true"
          data-live-search="true"
          title="Select type(s)"
          style="width: 180px; display: inline-block;"
        >
          {% for t in all_types %}
            <option value="{{ t }}" {% if t in type_filter %}selected{% endif %}>{{ t }}</option>
          {% endfor %}
        </select>

        <!-- Rule dropdown -->
        <select
          name="rule"
          class="selectpicker"
          multiple
          data-actions-box="true"
          data-live-search="true"
          title="Select rule(s)"
          style="width: 180px; display: inline-block;"
        >
          {% for r in all_rules %}
            <option value="{{ r }}" {% if r in rule_filter %}selected{% endif %}>{{ r }}</option>
          {% endfor %}
        </select>

        <!-- Acked / Unacked dropdown -->
        <select
          name="ack"
          class="selectpicker"
          data-actions-box="true"
          title="Acked / Unacked"
          style="width: 140px; display: inline-block;"
        >
          <option value="1" {% if '1' in ack_filter %}selected{% endif %}>Acked</option>
          <option value="0" {% if '0' in ack_filter %}selected{% endif %}>Unacked</option>
        </select>
      </div>

    </form>
  </div>
</div>


<script>
  $(document).ready(function() {
    $('.selectpicker').selectpicker();
  });
  // Help "popup"
  document.addEventListener("DOMContentLoaded", function () {
    var popoverTriggerList = [].slice.call(
      document.querySelectorAll('[data-bs-toggle="popover"]')
    );
    popoverTriggerList.map(function (popoverTriggerEl) {
      return new bootstrap.Popover(popoverTriggerEl);
    });
  });
</script>


{% if findings %}
<div class="mb-2 d-flex justify-content-end gap-1">
    <button type="button" class="btn btn-sm btn-success" id="select-all">Ack All</button>
    <button type="button" class="btn btn-sm btn-warning" id="deselect-all">Unack All</button>
</div>

<table class="table table-dark table-striped table-hover table-sm">
    <thead class="table-secondary">
        <tr>
            <th>#</th>
            <th>Collection</th>
            <th>Type</th>
            <th>Rule</th>
            <th>Message</th>
            <th>Artifact</th>
            <th>Acked</th>
            <th>Case</th>
        </tr>
    </thead>
    <tbody>
    {% for f in findings %}
        <tr class="finding-{{ f.type }}">
            <td><a href="/findings/{{ f.id }}" class="text-info text-decoration-none">{{ f.id }}</a></td>
            <td>{{ f.collection_name }}</td>
            <td>{{ f.type }}</td>
            <td>{{ f.rule }}</td>
            <td>
                <a href="/findings/{{ f.id }}" class="text-info text-decoration-none">{{ f.message }}</a>
            </td>
            <td class="mono">{{ f.artifact }}</td>
            <td>
<input
    type="checkbox"
    class="ack-checkbox"
    data-id="{{ f.id }}"
    {% if f.ack %}checked{% endif %}
/>

            </td>
            <td>
  <button class="btn btn-sm btn-info add-case-btn" data-id="{{ f.id }}">
    Add Case
  </button>
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>
{% else %}
<p class="text-light">No findings available.</p>
{% endif %}
<!-- Ack / Unack Comment Modal -->
<div class="modal fade" id="ackCommentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header">
        <h5 class="modal-title">Acknowledgement Comment</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="mb-3">
          <label for="ackComment" class="form-label">
            Please provide a reason <span class="text-danger">*</span>
          </label>
          <textarea
            class="form-control bg-dark text-light"
            id="ackComment"
            rows="3"
            placeholder="e.g. False positive, Accepted risk, Investigated..."
            required
          ></textarea>
          <div class="invalid-feedback">
            Comment is required.
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-primary" id="confirmAck">
          Confirm
        </button>
      </div>
    </div>
  </div>
</div>

<script>
$(document).ready(function() {

    let pendingAction = null;
    const modalEl = document.getElementById('ackCommentModal');
    const ackModal = new bootstrap.Modal(modalEl);

    function openAckModal(action) {
        pendingAction = action;
        $('#ackComment')
            .val('')
            .removeClass('is-invalid');
        ackModal.show();
    }

    $('#confirmAck').on('click', function() {
        const comment = $('#ackComment').val().trim();

        if (!comment) {
            $('#ackComment').addClass('is-invalid');
            return;
        }

        ackModal.hide();
        pendingAction(comment);
        pendingAction = null;
    });

    /* ---------- SINGLE ACK / UNACK ---------- */
    $('.ack-checkbox').on('change', function() {
        const checkbox = $(this);
        const findingId = checkbox.data('id');
        const ackValue = checkbox.is(':checked') ? 1 : 0;

        // revert immediately; apply only after success
        checkbox.prop('checked', !ackValue);

        openAckModal(function(comment) {
            $.ajax({
                url: `/findings/${findingId}/ack`,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    ack: ackValue,
                    ack_comment: comment
                }),
                success: function() {
                    checkbox.prop('checked', ackValue);
                },
                error: function() {
                    alert('Error updating ack');
                }
            });
        });
    });

    /* ---------- BULK ACK / UNACK ---------- */
    function bulkAck(setChecked) {
        const ids = $('.ack-checkbox').map(function() {
            return $(this).data('id');
        }).get();

        openAckModal(function(comment) {
            $('.ack-checkbox').prop('checked', setChecked);

            $.ajax({
                url: '/findings/bulk_ack',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    ids: ids,
                    ack: setChecked ? 1 : 0,
                    ack_comment: comment
                }),
                success: function(response) {
                    console.log('Bulk ack updated', response);
                },
                error: function(err) {
                    alert('Error updating bulk ack');
                    console.error(err);
                }
            });
        });
    }

    $('#select-all').on('click', function() {
        bulkAck(true);
    });

    $('#deselect-all').on('click', function() {
        bulkAck(false);
    });

});
</script>

{% include "_add_case.html" %}

{% endblock %}
