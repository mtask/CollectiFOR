{% extends "base_timeline.html" %}

{% block content %}
<h2>Timeline Explorer</h2>

<div class="row mb-3 justify-content-center">
    <div class="col-md-3">
        <label>Start Time</label>
        <input id="start-time" class="form-control" placeholder="dd/mm/yyyy HH:mm">
    </div>

    <div class="col-md-3">
        <label>End Time</label>
        <input id="end-time" class="form-control" placeholder="dd/mm/yyyy HH:mm">
    </div>

    <div class="col-md-3">
        <label>Sort Order</label>
        <select id="sort-order" class="form-control">
            <option value="timestamp desc" selected>Timestamp (DESC)</option>
            <option value="timestamp asc">Timestamp (ASC)</option>
            <option value="message desc" selected>Message (DESC)</option>
            <option value="message asc">Message (ASC)</option>
            <option value="data_type desc" selected>Data Type (DESC)</option>
            <option value="data_type asc" selected>Data Type (ASC)</option>
            <option value="timestamp_desc desc" selected>Timestamp Description (DESC)</option>
            <option value="timestamp_desc asc" selected>Timestamp Description (ASC)</option>
        </select>
    </div>
</div>

<div class="row mb-3 justify-content-center align-items-end">
    <div class="col-md-10">
        <label>DuckDB SQL Filter</label>

        <div class="input-group">
            <input
                type="text"
                id="sql-filter"
                class="form-control"
                placeholder="e.g. message ILIKE '%error%' AND data_type='syslog:line'"
                spellcheck="false"
                autocorrect="off"
                autocapitalize="off"
            >

            <button
                class="btn btn-outline-success dropdown-toggle"
                type="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
            >
                Helpers
            </button>

            <ul class="dropdown-menu dropdown-menu-end">
                <li>
                    <a class="dropdown-item filter-helper"
                       href="#"
                       data-snippet="message ILIKE '%error%'">
                        Message ILIKE
                    </a>
                </li>
                <li>
                    <a class="dropdown-item filter-helper"
                       href="#"
                       data-snippet="filename ILIKE '%log%'">
                        Filename ILIKE
                    </a>
                </li>
                <li>
                    <a class="dropdown-item filter-helper"
                       href="#"
                       data-snippet="json_extract_string(extra, '$.strings') ILIKE '%persistence%'">
                       extra.strings ILIKE
                    </a>
                </li>
                <li>
                    <a class="dropdown-item filter-helper"
                       href="#"
                       data-snippet="data_type = 'syslog:line'">
                        Filter by data type
                    </a>
                </li>
                <li>
                    <a class="dropdown-item filter-helper"
                       href="#"
                       data-snippet="json_extract_string(extra, '$.sha256_hash') = 'HASH HERE'">
                        SHA256 hash
                    </a>
                </li>
                <li>
                    <a class="dropdown-item filter-helper"
                       href="#"
                       data-snippet="json_extract_string(extra, '$.sha1_hash') = 'HASH HERE'">
                        SHA1 hash
                    </a>
                </li>
                <li>
                    <a class="dropdown-item filter-helper"
                       href="#"
                       data-snippet="timestamp_desc = 'Content Modification Time'">
                       timestamp_desc: Content Modification Time
                    </a>
                </li>
                <li>
                    <a class="dropdown-item filter-helper"
                       href="#"
                       data-snippet="timestamp_desc = 'Last Access Time'">
                       timestamp_desc: Last Access Time
                    </a>
                </li>
                <li>
                    <a class="dropdown-item filter-helper"
                       href="#"
                       data-snippet="timestamp_desc = 'Metadata Modification Time'">
                       timestamp_desc: Metadata Modification Time
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <div class="col-md-2">
        <button id="apply-filter" class="btn btn-primary w-100">
            Filter
        </button>
    </div>
</div>

<div class="table-responsive">
<table id="timeline-table" class="table table-striped table-bordered display nowrap" style="width:100%">
    <thead>
        <tr>
            <th>Timestamp</th>
            <th>Timestamp Description</th>
            <th>Data Type</th>
            <th>Message</th>
            <th>Event</th>
        </tr>
    </thead>
</table>
</div>

<!-- Event Modal -->
<div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Event Details</h5>
                <button class="btn btn-sm btn-outline-secondary me-2" id="copy-event-btn" title="Copy full event">ðŸ“‹</button>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre id="event-json" class="mb-0"></pre>
            </div>
        </div>
    </div>
</div>

<!-- Toast container -->
<div id="toast-container" class="position-fixed top-0 end-0 p-3" style="z-index:1055;"></div>


<script>
$(document).ready(function() {

    const startPicker = flatpickr("#start-time", {
        enableTime: true,
        dateFormat: "d/m/Y H:i",
        time_24hr: true
    });

    const endPicker = flatpickr("#end-time", {
        enableTime: true,
        dateFormat: "d/m/Y H:i",
        time_24hr: true
    });

    function showToast(msg) {
        const id = 'toast-' + Date.now();
        $('#toast-container').append(`
            <div id="${id}" class="toast text-bg-primary border-0">
                <div class="d-flex">
                    <div class="toast-body">${msg}</div>
                    <button class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `);
        new bootstrap.Toast(document.getElementById(id), { delay: 2000 }).show();
    }

    const table = $('#timeline-table').DataTable({
        serverSide: true,
        processing: true,
        searching: false,
        ordering: false,
        ajax: {
            url: "{{ url_for('timeline_data') }}",
            data: function(d) {
                d.start_time = startPicker.selectedDates.length
                    ? Math.floor(startPicker.selectedDates[0].getTime() / 1000)
                    : null;

                d.end_time = endPicker.selectedDates.length
                    ? Math.floor(endPicker.selectedDates[0].getTime() / 1000)
                    : null;

                d.sql_filter = $('#sql-filter').val();
                
                d.sort_order = $('#sort-order').val();
            }
        },
        columns: [
            { data: 'timestamp', render: ts => new Date(ts/1000).toLocaleString('en-GB') },
            { data: 'timestamp_desc' },
            { data: 'data_type' },
            {
                data: 'message',
                className: 'message'

            },
            {
                data: 'id',
                orderable: false,
                render: id => `<button class="btn btn-sm btn-primary show-event" data-id="${id}">Show Event</button>`
            }
        ],
        columnDefs: [
           { targets: 0, width: "12%" },
           { targets: 1, width: "10%" },
           { targets: 2, width: "8%" },
           { targets: 3, width: "auto" },
           { targets: 4, width: "10%" }
        ],
        order: [[0, 'asc']],
        pageLength: 50,
        autoWidth: false,
        scrollX: true
    });

    table.columns.adjust();

    $('#apply-filter').on('click', function() {
        table.ajax.reload();
    });


    $('#timeline-table').on('click', '.show-event', function() {
        const id = $(this).data('id');
        fetch(`/api/timeline_event/${id}`)
            .then(r => r.json())
            .then(data => {
                // Pretty-print JSON
                const jsonText = JSON.stringify(data, null, 2);
                $('#event-json').text(jsonText);

                // Trigger Prism syntax highlighting
                Prism.highlightElement(document.getElementById('event-json'));

                new bootstrap.Modal('#eventModal').show();
            });
    });


    // Copy button in event modal
    $('#copy-event-btn').on('click', function() {
        const text = $('#event-json').text();
        navigator.clipboard.writeText(text).then(() => showToast('Full event copied'));
    });


    $('#apply-filter').on('click', () => table.ajax.reload());

    $(document).on('click', '.filter-helper', function (e) {
        e.preventDefault();
        const snippet = $(this).data('snippet');
        const input = $('#sql-filter');
       // Replace entire input with snippet:
       input.val(snippet);
       // Focus the input:
       input.focus();
    });

});
</script>

{% endblock %}

