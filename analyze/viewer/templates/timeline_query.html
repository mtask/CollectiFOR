{% extends "base_timeline.html" %}

{% block content %}
<div class="container bg-transparent">
  <div class="row justify-content-center">
    <div class="col-md-6 text-center">

      <h2 class="text-light mb-3">Timeline Query</h2>

      <div class="mx-auto mb-4 p-2 px-3
                  bg-primary bg-opacity-25
                  border-start border-3 border-primary
                  text-light
                  rounded"
           style="font-size: 0.9rem;">
        <strong>Note:</strong> Timeline selection does not affect this view as it is a direct database query interface.<br/>Shown results are limited to max 5000.
      </div>

      <!-- Saved Queries Dropdown -->
      <div class="d-flex align-items-center justify-content-center gap-2">
         <select id="saved-query-select" class="form-select text-center w-auto" style="max-width: 280px;">
          <option value="">-- Select saved query --</option>
          {% for name, query in saved_queries %}
            <option value="{{ query|e }}">{{ name }}</option>
          {% endfor %}
        </select>
      </div>

    </div>
  </div>
</div>

<form method="get" action="{{ url_for('timeline_query') }}" id="query-form">
    <div class="row mb-3 justify-content-center align-items-start">
        <div class="col-md-12">
            <label for="sql-filter" class="form-label">DuckDB SQL Query</label>

            <!-- Flex container for textarea + buttons -->
            <div class="d-flex align-items-start gap-2">
                <!-- Auto-growing textarea -->
                <textarea
                    id="sql-filter"
                    name="sql_filter"
                    class="form-control"
                    rows="1"
                    style="resize: none; overflow: hidden;"
                    spellcheck="false"
                    autocorrect="off"
                    autocapitalize="off"
                    placeholder="Enter full SQL query, e.g. SELECT * FROM timeline_events LIMIT 10"
                >{{ sql_query|default('') }}</textarea>

                <!-- Buttons fixed height, won't grow with textarea -->
                <div class="btn-group flex-shrink-0">
                    <button type="submit" class="btn btn-primary">Run</button>
                    <button type="button" class="btn btn-secondary" id="save-query-btn">Save</button>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- Auto-grow JS -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    const ta = document.getElementById('sql-filter');

    const resize = () => {
        ta.style.height = 'auto';
        ta.style.height = ta.scrollHeight + 'px';
    };

    ta.addEventListener('input', resize);
    resize(); // Resize on page load for existing content
});
</script>

<div id="loading-overlay" 
     style="
        display:none;
        position:fixed;
        top:0; left:0;
        width:100%; height:100%;
        background: rgba(27,39,51,0.8);
        color:#fff;
        font-size:1.5rem;
        text-align:center;
        line-height:100vh;
        z-index:2000;
     ">
    Loading results...
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('query-form');
    const overlay = document.getElementById('loading-overlay');

    if (form && overlay) {
        form.addEventListener('submit', () => {
            overlay.style.display = 'block';
        });
    }
});
</script>


{% if not result_df.empty %}
<div class="row">
    <div class="col-12">

        <!-- Buttons above the pre -->
        <div class="d-flex justify-content-end gap-2 mb-1">
            <button
                id="copy-result-btn"
                class="btn btn-sm btn-outline-light"
            >
                <i class="bi bi-clipboard"></i> Copy
            </button>

            <button
                id="export-result-btn"
                class="btn btn-sm btn-outline-light"
            >
                <i class="bi bi-download"></i> Export
            </button>
        </div>

        <!-- Result pre block -->
        <pre
            id="result-pre"
            class="p-3"
            style="background-color: black; color: #00FF00; overflow:auto; max-height: 70vh;"
        >
{{ result_df.to_csv(sep='|', index=False, header=True) }}
        </pre>
    </div>
</div>

<!-- Toast container -->
<div
    id="toast-container"
    class="position-fixed top-0 end-0 p-3"
    style="z-index:1055;"
></div>

<script>
/* Copy to clipboard */
document.getElementById('copy-result-btn').addEventListener('click', () => {
    const text = document.getElementById('result-pre').innerText;
    navigator.clipboard.writeText(text).then(() => {
        const id = 'toast-' + Date.now();
        const toastHtml = `
            <div id="${id}" class="toast text-bg-success border-0">
                <div class="d-flex">
                    <div class="toast-body">Copied to clipboard</div>
                    <button class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;
        document.getElementById('toast-container')
            .insertAdjacentHTML('beforeend', toastHtml);
        new bootstrap.Toast(
            document.getElementById(id),
            { delay: 2000 }
        ).show();
    });
});

/* Export CSV including headers */
document.getElementById('export-result-btn').addEventListener('click', () => {
    const csvText = `{{ result_df.to_csv(index=False, header=True) | replace('\n','\\n') | replace('\r','') }}`;
    const blob = new Blob([csvText], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = 'timeline_result.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
});
</script>
{% endif %}

<!-- Save query + dropdown behavior -->
<script>
// Wait until DOM is ready
document.addEventListener('DOMContentLoaded', () => {

    const select = document.getElementById('saved-query-select');
    const sqlInput = document.getElementById('sql-filter');
    const saveBtn = document.getElementById('save-query-btn');

    if (select && sqlInput) {
        select.addEventListener('change', function () {
            sqlInput.value = this.value || '';
        });
    }

    if (saveBtn && select && sqlInput) {
        saveBtn.addEventListener('click', async () => {
            const query = sqlInput.value.trim();
            if (!query) return;

            const name = prompt("Save query as:");
            if (!name) return;

            try {
                const formData = new FormData();
                formData.append('query_name', name);
                formData.append('sql_filter', query);

                const response = await fetch("{{ url_for('timeline_query') }}", {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) throw new Error("Save failed");

                // Check if the option already exists
                let existingOption = Array.from(select.options).find(opt => opt.value === query);
                if (!existingOption) {
                    const option = document.createElement('option');
                    option.value = query;
                    option.textContent = name;
                    select.appendChild(option);
                }

                // Select the newly saved query
                select.value = query;

                // Trigger the 'change' event so input is updated
                select.dispatchEvent(new Event('change'));

                alert("Query saved successfully!");
            } catch (err) {
                console.error(err);
                alert("Failed to save query");
            }
        });
    }

});
</script>

{% endblock %}
