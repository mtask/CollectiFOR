{% extends "base.html" %}
{% block style %}
textarea.checksum-input {
    background-color: #0d1a26;
    color: #d1d9e0;
    border: 1px solid #3a4a5a;
}

textarea.checksum-input::placeholder {
    color: #d1d9e0;
    opacity: 1;
}

textarea.checksum-input:focus {
    background-color: #0d1a26;
    color: #00ff00;
    border: 1px solid #00ff00;
    box-shadow: 0 0 5px #00ff00;
    outline: none;
}
{% endblock %}
{% block content %}

<div class="container bg-transparent">
  <div class="row justify-content-center">
    <div class="col-md-8">

      <h2 class="text-light text-center mb-3">üîç Checksum Search</h2>

      <div class="mx-auto mb-4 p-2 px-3
                  bg-primary bg-opacity-25
                  border-start border-3 border-primary
                  text-light
                  rounded"
           style="font-size: 1.0rem;">
        <strong>
          Provide checksums to search from collections' database content.
          Choose one input method below.
        </strong>
      </div>

      <form method="POST" enctype="multipart/form-data" class="bg-dark p-4 rounded shadow">

        <!-- Paste checksums -->
        <div class="mb-4">
          <label class="form-label text-light">
            üìã Paste checksums (one per line)
          </label>
<textarea
  name="checksums_text"
  class="form-control checksum-input"
  rows="6"
  placeholder="e.g.
d41d8cd98f00b204e9800998ecf8427e
44d88612fea8a8f36de82e1278abb02f filename">
</textarea>

        </div>

        <hr class="border-secondary">

        <!-- Upload file -->
        <div class="mb-4">
          <label class="form-label text-light">
            üìÅ Upload checksum file
          </label>
          <input
            type="file"
            name="checksums_file"
            class="form-control bg-black text-light border-secondary"
            accept=".txt,.list,.hashes">
          <div class="form-text text-light">
            Text file containing one checksum per line. Checksum needs to be followed by whitespace if other content on the same line.
          </div>
        </div>

        <div class="d-grid">
          <button type="submit" class="btn btn-primary btn-lg">
            Search
          </button>
        </div>

      </form>

    </div>
  </div>
</div>

{% if errors %}
  <div class="alert alert-danger">{{ errors|join('\n') }}</div>
{% endif %}
{% if results|length == 0 %}
  <div class="alert alert-success">No matches with provided checksums</div>
{% endif %}
{% if results %}
<div class="mt-4">

  <h4 class="text-light mb-3">üîé Matching Checksums</h4>

  <div class="table-responsive">
    <table class="table table-dark table-hover table-sm align-middle">
      <thead class="table-secondary text-dark">
        <tr>
          <th>Collection</th>
          <th>Algorithm</th>
          <th>Checksum</th>
          <th>Filename</th>
          <th>Filepath</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for result in results %}
        <tr>
          <td>{{ result.collection_name }}</td>
          <td><code>{{ result.algorithm }}</code></td>
          <td class="font-monospace text-break">
            {{ result.checksum }}
          </td>
          <td>{{ result.filename }}</td>
          <td class="text-break">{{ result.filepath }}</td>
          <td class="text-center">

            <button
              type="button"
              class="btn btn-sm btn-warning make-finding-btn"
              data-finding='{
                "indicator": "{{ result.checksum }}",
                "artifact": "{{ result.filepath }}",
                "message": "Checksum match ({{ result.algorithm }})",
                "collection": "{{ result.collection_name }}",
                "meta": {
                  "filename": "{{ result.filename }}",
                  "filepath": "{{ result.filepath }}",
                  "algorithm": "{{ result.algorithm }}",
                  "checksum": "{{ result.checksum }}"
                }
              }'
            >
              <i class="bi bi-plus-circle me-1"></i>
              Make Finding
            </button>

          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>
{% endif %}
<script>
document.addEventListener('click', function (e) {
  const btn = e.target.closest('.make-finding-btn');
  if (!btn) return;

  const data = JSON.parse(btn.dataset.finding);

  document.getElementById('findingMessage').value =
    data.message + "\nIndicator: " + data.indicator;

  document.getElementById('findingArtifact').value = data.artifact || '';
  document.getElementById('findingIndicator').value = data.indicator || '';
  document.getElementById('findingMeta').value =
    JSON.stringify(data.meta, null, 2);

  const modalEl = document.getElementById('addFindingModal');
  const modal = new bootstrap.Modal(modalEl);
  modal.show();

  modalEl.addEventListener('shown.bs.modal', function () {
    const collectionSelect = document.getElementById('findingCollection');
    const timelineSelect = document.getElementById('findingTimeline');

    if (data.collection) {
      collectionSelect.value = data.collection;
    } else {
      collectionSelect.value = "{{ session.get('collection_name') }}";
    }

    timelineSelect.value = "{{ session.get('timeline_name') }}";
  }, { once: true });

});
</script>

{% endblock %}
